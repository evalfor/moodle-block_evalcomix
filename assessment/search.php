<?php/** * @package    block_evalcomix * @copyright  2010 onwards EVALfor Research Group {@link http://evalfor.net/} * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later * @author     Daniel Cabeza Sánchez <daniel.cabeza@uca.es>, Juan Antonio Caballero Hernández <juanantonio.caballero@uca.es> */ require_once('../../../config.php');require_once($CFG->dirroot . '/blocks/evalcomix/assessment/lib.php');include_once($CFG->dirroot . '/blocks/evalcomix/classes/evalcomix_allowedusers.php');$search = required_param('search', PARAM_RAW);$courseid 	   = required_param('id', PARAM_INT);        // course id$id = required_param('a', PARAM_INT);$type = optional_param('t', 0, PARAM_INT);$assessorid = optional_param('as', 0, PARAM_INT);require_login($courseid);if ($id) {	$cm = get_coursemodule_from_id('', $id, 0, false, MUST_EXIST);	if (!$course = $DB->get_record('course', array('id' => $courseid))) {		print_error('nocourseid');	}}$context = context_course::instance($courseid);$report_evalcomix = new grade_report_evalcomix($courseid, null, $context);$users = $report_evalcomix->load_users(false);$allowedusershash = array();$output = '<select id="assessorid" name="assessorid" style="width:20em" size="20" onclick="document.getElementById(\'submit\').disabled = false;doWork(\'targetstudents\', \'targetstudents.php\', \'u=\'+this.value+\'&id='.$courseid.'&a='.$cm->id.'\');">';if($type == 'potential' && $assessorid > 0){	$allowedusershash[$assessorid] = true;	if($allowedusers = evalcomix_allowedusers::fetch_all(array('cmid' => $id, 'assessorid' => $assessorid))){		foreach($allowedusers as $alloweduser){			$userid = $alloweduser->studentid;			$allowedusershash[$userid] = true;		}	}	$output = '<select multiple name="pu[]" style="width:20em" size="20" onchange="document.getElementById(\'add\').disabled=false">';}foreach($users as $user){	$needle = trim($search);	if($needle != ''){		$pos1 = strpos($user->firstname, $needle);		$pos2 = strpos($user->lastname, $needle);		$userid = $user->id;		if(!isset($allowedusershash[$userid])){			if ($pos1 !== false || $pos2 !== false) {				$output .= '<option value="'.$userid.'">'.fullname($user).'</option>';			}		}	}	else{		$userid = $user->id;		if(!isset($allowedusershash[$userid])){			$output .='<option value="'.$user->id.'">'.fullname($user).'</option>';		}	}}$output .= '</select>';echo $output;?>